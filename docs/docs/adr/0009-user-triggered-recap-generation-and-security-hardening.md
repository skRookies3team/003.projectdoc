# [ADR-0009] **사용자 중심 리캡 생성 및 보안 강화 전략**

- **상태**: 승인됨 (Accepted) [2025-01-05]
- **결정자**: 김지은
- **관련 문서**: Issue #26, PR #52 / #57

## 1. 배경 및 문제 (Context)

기존 리캡 시스템은 매월 1일 모든 사용자의 데이터를 일괄 스캔하여 리캡을 생성하는 '전체 배치(Global Batch)' 방식을 채택하고 있었습니다. 그러나 서비스 성장에 따라 다음과 같은 문제에 직면했습니다.

1. **AI API 비용 폭증**: 일기 기록이 적거나 리캡을 확인하지 않는 유저까지 포함하여 모든 유저에 대해 AI 분석을 실행하는 것은 불필요한 비용 소모를 초래함.
2. **보안 취약점 (IDOR)**: 리캡 ID 조회 시 소유권 검증 로직이 부재하여, 다른 사용자의 리캡 데이터가 노출될 위험이 존재함.
3. **다중 반려동물 대응 미흡**: 유저가 여러 마리의 펫을 키우는 경우, 각 펫별로 독립적인 리캡을 생성하고 관리하는 로직이 모호했음.
4. **이미지 처리 비효율**: 리캡 생성 시 50장 이상의 이미지를 다시 분석하는 것은 높은 지연 시간(Latency)과 비용을 유발함.

## 2. 결정 사항 (Decision)

우리는 **전체 사용자 배치 방식을 폐기**하고, **사용자 트리거 및 예약 기반 시스템**을 도입하기로 결정했습니다.

1. **전체 배치 로직 삭제**: 스케줄러가 임의로 모든 유저를 훑는 로직을 제거함.
2. **예약(Reservation) 시스템 도입**: `/schedule/auto`를 통해 `WAITING` 상태의 예약 데이터를 생성하고, 기간 종료 후 스케줄러가 해당 건만 처리함.
3. **사용자별 다중 펫 지원**: 일기 데이터를 기반으로 해당 유저의 모든 `petId`를 식별하여 펫별 독립 리캡을 일괄 생성하는 엔드포인트(`generate/manual/all`)를 구축함.
4. **다단계 보안 검증**: 일기 조회 전 펫 소유권을 확인하고, 리캡 상세 조회 시 요청 유저 ID와 소유자 ID 대조 로직을 필수 적용함.
5. **이미지 처리 최적화**: AI 재분석 대신, 일기 작성 시의 분석 결과를 신뢰하고 시스템 로직을 통해 대표 이미지 8장을 무작위 추출(Shuffle & Limit)하여 리캡을 구성함.

## 3. 결정 근거 (Decision Drivers)

1. **비용 최적화 (Cost Efficiency)**: 명시적으로 리캡을 원하는 유저(예약자 또는 수동 요청자)에게만 AI 자원을 할당하여 운영 비용을 절감함.
2. **데이터 보안 (Data Security)**: 펫 정보가 외부 서비스에 있는 상황에서도 일기 작성 이력을 통해 소유권을 검증함으로써 IDOR 공격을 원천 차단함.
3. **확장성 및 성능 (Scalability)**: 전체 유저 스캔 쿼리를 제거하여 DB 부하를 줄이고, 이미지 처리를 텍스트 요약과 분리하여 응답 속도를 개선함.

## 4. 고려했던 대안들 (Considered Options)

- **Option 1: 기존 전체 배치 유지 및 필터링 강화**
    - 일기 작성 횟수가 특정 수치 이상인 유저만 골라 생성하는 방식. 여전히 불필요한 자원 소모가 발생함.
- **Option 2: 실시간 생성 (On-the-fly)**
    - 사용자가 리캡 메뉴를 클릭할 때 실시간으로 AI를 돌려 생성하는 방식. AI 분석 시간이 길어(수 초~십수 초) 사용자 경험(UX) 저하 우려.
- **Option 3: 이미지 Vision AI 재분석**
    - 리캡 생성 시 모든 이미지를 다시 분석하여 가장 예쁜 사진을 고르는 방식. 비용과 시간 측면에서 기각됨.

## 5. 장단점 분석 (Pros and Cons)

### [선택안] 사용자 트리거 및 예약 기반 시스템 (채택됨)

- **장점**:
    - AI API 호출 비용의 획기적 절감.
    - 개인정보 보안 수준 대폭 향상.
    - 펫별 리캡 히스토리 관리의 명확성.
- **단점**:
    - 사용자가 직접 예약하거나 요청해야 리캡이 생성되므로, 리드(Lead)가 없는 유저는 리캡을 놓칠 수 있음 (알림 서비스로 보완 필요).

### [Option 1] 기존 전체 배치 방식

- **장점**: 모든 유저에게 균일한 서비스 제공 가능.
- **단점**: 유저가 늘어날수록 서버 부하와 비용이 선형적으로 증가함. 데이터 보안 로직 추가가 까다로움.

## 6. 결과 및 영향 (Consequences)

- **긍정적**: AI 토큰 소모량 예측 가능 및 제어 용이, 개인정보보호 규정 준수 강화, 펫별 커스터마이징된 리캡 제공 가능.
- **부정적**: 프론트엔드에서 '지난달 리캡 생성' 및 '예약하기' 등의 추가 UI 구현이 필요하며, 사용자의 능동적인 액션이 요구됨.
